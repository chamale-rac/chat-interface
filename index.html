<html>
  <head> </head>
  <body>
    <script>
      const ulStyle = `
        list-style-type: none; 
        overflow-y: scroll;
        height: 90vh;
      `;

      const liStyle = `
      `;

      const spanStyle = `
        font-weight: bold;
      `;

      const detailsStyle = `
      `;

      const summaryStyle = `
        cursor: pointer;
        list-style: none; 
      `;

      const formStyle = `
        height: 10vh;
            `;

      const inputStyle = `
            `;

      const buttonStyle = `
            `;

      const ul = document.createElement("ul");
      ul.style.cssText = ulStyle;

      const form = document.createElement("form");
      const input = document.createElement("input");
      const submit = document.createElement("input");
      submit.type = "submit";
      submit.value = "SEND";
      input.required = true;
      input.maxLength = 140;
      input.placeholder = "Your message...";
      form.append(input);
      form.append(submit);

      const messageElements = () => {
        const li = document.createElement("li");
        const span = document.createElement("span");
        const details = document.createElement("details");
        const summary = document.createElement("summary");

        li.style.cssText = liStyle;
        span.style.cssText = spanStyle;
        details.style.cssText = detailsStyle;
        summary.style.cssText = summaryStyle;

        return [li, span, details, summary];
      };

      const messageStructure = (text, user, created_on) => {
        const [li, span, details, summary] = messageElements();
        span.append(`${user}:`);
        summary.append(text);
        details.append(summary);
        details.append(created_on);

        li.append(span);
        li.append(details);

        return li;
      };

      const getMessages = async (eventType, savedScrollTop) => {
        const response = await fetch("http://uvgenios.online/api/messages");
        const messages = await response.json();

        const liList = messages.map((message) =>
          messageStructure(message.text, message.user, message.created_on)
        );
        liList.forEach((li) => ul.append(li));

        switch (eventType) {
          case "initial":
            ul.scrollTop = ul.scrollHeight;
            break;
          case "using":
            ul.scrollTop = savedScrollTop;
        }
      };

      const postMessage = async (text) => {
        const body = {
          text,
          user: "user1",
        };
        const response = await fetch("http://uvgenios.online/api/messages", {
          method: "POST",
          body: JSON.stringify(body),
          headers: {
            "Content-Type": "application/json",
          },
        });
        return response;
      };

      const sendRefresh = () => {
        const savedScrollTop = ul.scrollTop;
        ul.innerHTML = "";
        input.value = "";
        getMessages("using", savedScrollTop);
      };

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        await postMessage(input.value);
        sendRefresh();
      });

      getMessages("initial");
      document.body.append(ul);
      document.body.append(form);
    </script>
  </body>
</html>
